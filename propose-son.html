<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="description" content="Propose un son pour une ref">
  <meta name="theme-color" content="#FF6B9D">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <!-- Styles -->
  <link rel="stylesheet" href="style.css">

  <title>Proposer un son - RefBox</title>
</head>
<body>
  <div class="form-page">
    <!-- Header -->
    <div class="form-header">
      <h1>Envoie ton son ! üé§</h1>
      <p id="refInfo">Charge le fichier audio pour cette ref</p>
    </div>

    <!-- Message de succ√®s (cach√© par d√©faut) -->
    <div id="successMessage" class="message success" style="display: none;">
      ‚úì Son propos√© avec succ√®s ! Il sera bient√¥t en ligne.
    </div>

    <!-- Message d'erreur (cach√© par d√©faut) -->
    <div id="errorMessage" class="message error" style="display: none;">
      Erreur lors de l'envoi. V√©rifie le fichier et r√©essaie.
    </div>

    <!-- Formulaire -->
    <form class="form" id="sonForm" method="POST" action="https://formspree.io/f/xeorbknp" enctype="multipart/form-data">
      <!-- Nom de la ref (hidden, pr√©-rempli) -->
      <input type="hidden" id="refId" name="refId" required>

      <!-- Champs cach√©s pour tra√ßabilit√© -->
      <input type="hidden" id="userId" name="userId">
      <input type="hidden" id="userEmail" name="userEmail">

      <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px; margin-bottom: 24px;">
        <strong style="font-size: 18px;">Ref s√©lectionn√©e :</strong>
        <div id="refName" style="font-size: 20px; color: var(--color-1); margin-top: 8px; font-weight: bold;">
          -
        </div>
      </div>

      <!-- Upload fichier audio -->
      <div class="form-group">
        <label for="audioFile">Fichier audio *</label>
        <div class="file-input-wrapper">
          <label for="audioFile" class="file-input-label" id="fileLabel">
            <span style="font-size: 32px;">üéµ</span>
            <div>
              <div style="font-weight: 600; margin-bottom: 4px;">Clique pour choisir un fichier</div>
              <div style="font-size: 12px; opacity: 0.7;">MP3, M4A ou WAV (max 10 MB)</div>
            </div>
          </label>
          <input
            type="file"
            id="audioFile"
            name="audioFile"
            class="file-input"
            accept=".mp3,.m4a,.wav,audio/mpeg,audio/mp4,audio/wav"
            required
          >
          <div id="fileName" class="file-name"></div>
        </div>
        <small>Formats accept√©s : MP3, M4A, WAV ‚Ä¢ Taille max : 10 MB</small>
      </div>

      <!-- Ton nom -->
      <div class="form-group">
        <label for="userName">Ton nom *</label>
        <input
          type="text"
          id="userName"
          name="userName"
          placeholder="ex: Mamadou"
          required
          maxlength="50"
          autocomplete="name"
        >
      </div>

      <!-- Note/Contexte -->
      <div class="form-group">
        <label for="note">Note ou contexte (optionnel)</label>
        <textarea
          id="note"
          name="note"
          placeholder="Pr√©cisions sur l'enregistrement, la qualit√©, etc."
          maxlength="300"
        ></textarea>
        <small>Maximum 300 caract√®res</small>
      </div>

      <!-- Bouton submit -->
      <button type="submit" class="submit-btn" id="submitBtn">
        Envoyer mon son
      </button>

      <!-- Lien retour -->
      <a href="index.html" class="back-link">‚Üê Retour au soundboard</a>
    </form>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

  <!-- Configuration et Auth -->
  <script src="firebase-config.js"></script>
  <script src="auth.js"></script>

  <script>
    /* ============================================
       GESTION DU FORMULAIRE
       ============================================ */

    const form = document.getElementById('sonForm');
    const submitBtn = document.getElementById('submitBtn');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    const fileInput = document.getElementById('audioFile');
    const fileLabel = document.getElementById('fileLabel');
    const fileName = document.getElementById('fileName');
    const refIdInput = document.getElementById('refId');
    const refNameDisplay = document.getElementById('refName');
    const refInfo = document.getElementById('refInfo');

    // Taille max en bytes (10 MB)
    const MAX_FILE_SIZE = 10 * 1024 * 1024;

    /* ============================================
       AUTHENTIFICATION
       ============================================ */

    // V√©rifier l'authentification au chargement
    initAuthObserver((user) => {
      if (!user) {
        // Rediriger vers login si pas connect√©
        window.location.href = 'login.html';
        return;
      }

      // Pr√©-remplir les champs utilisateur
      const userInfo = getUserInfo();
      if (userInfo) {
        document.getElementById('userId').value = userInfo.uid;
        document.getElementById('userEmail').value = userInfo.email;
        document.getElementById('userName').value = userInfo.displayName;
      }
    });

    /* ============================================
       R√âCUP√âRATION DU PARAM√àTRE URL
       ============================================ */

    // R√©cup√©rer le param√®tre ?ref= depuis l'URL
    const urlParams = new URLSearchParams(window.location.search);
    const refParam = urlParams.get('ref');

    if (!refParam) {
      // Si pas de param√®tre, rediriger vers l'accueil
      showError('Aucune ref sp√©cifi√©e. Retour au soundboard...');
      setTimeout(() => {
        window.location.href = 'index.html';
      }, 2000);
    } else {
      // Charger les infos de la ref depuis refs.json
      loadRefInfo(refParam);
    }

    // Charger les infos de la ref
    async function loadRefInfo(refId) {
      try {
        const response = await fetch(`refs.json?t=${Date.now()}`);
        if (!response.ok) throw new Error('Impossible de charger les refs');

        const data = await response.json();
        const ref = data.refs.find(r => r.id === refId);

        if (ref) {
          // Afficher le nom de la ref
          refNameDisplay.textContent = ref.name;
          refInfo.textContent = `Propose un son pour : ${ref.name}`;
          refIdInput.value = ref.id;
        } else {
          throw new Error('Ref non trouv√©e');
        }
      } catch (error) {
        console.error('Erreur:', error);
        showError('Ref introuvable. Retour au soundboard...');
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 2000);
      }
    }

    /* ============================================
       GESTION DU FICHIER
       ============================================ */

    // Changement de fichier
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];

      if (!file) {
        resetFileInput();
        return;
      }

      // Validation de la taille
      if (file.size > MAX_FILE_SIZE) {
        showError(`Le fichier est trop volumineux (${(file.size / 1024 / 1024).toFixed(1)} MB). Maximum : 10 MB.`);
        resetFileInput();
        return;
      }

      // Validation du format
      const validFormats = ['audio/mpeg', 'audio/mp3', 'audio/mp4', 'audio/x-m4a', 'audio/wav', 'audio/wave'];
      const fileExtension = file.name.split('.').pop().toLowerCase();
      const validExtensions = ['mp3', 'm4a', 'wav'];

      if (!validFormats.includes(file.type) && !validExtensions.includes(fileExtension)) {
        showError('Format de fichier non valide. Utilise MP3, M4A ou WAV.');
        resetFileInput();
        return;
      }

      // Afficher le nom du fichier
      fileName.textContent = `‚úì ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
      fileLabel.classList.add('has-file');

      // Cacher les messages d'erreur
      errorMessage.style.display = 'none';
    });

    // R√©initialiser l'input fichier
    function resetFileInput() {
      fileInput.value = '';
      fileName.textContent = '';
      fileLabel.classList.remove('has-file');
    }

    /* ============================================
       SOUMISSION DU FORMULAIRE
       ============================================ */

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Validation
      const file = fileInput.files[0];
      const userName = document.getElementById('userName').value.trim();

      if (!file) {
        showError('Merci de s√©lectionner un fichier audio');
        return;
      }

      if (!userName) {
        showError('Merci d\'indiquer ton nom');
        return;
      }

      if (file.size > MAX_FILE_SIZE) {
        showError('Le fichier est trop volumineux (max 10 MB)');
        return;
      }

      // D√©sactiver le bouton pendant l'envoi
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading"></span> Envoi en cours...';

      // Cacher les messages pr√©c√©dents
      successMessage.style.display = 'none';
      errorMessage.style.display = 'none';

      try {
        // Envoyer les donn√©es √† Formspree
        const formData = new FormData(form);
        const response = await fetch(form.action, {
          method: 'POST',
          body: formData,
          headers: {
            'Accept': 'application/json'
          }
        });

        if (response.ok) {
          // Succ√®s
          showSuccess();

          // R√©initialiser le formulaire
          form.reset();
          resetFileInput();

          // Rediriger vers l'accueil apr√®s 3 secondes
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 3000);
        } else {
          throw new Error('Erreur serveur');
        }
      } catch (error) {
        console.error('Erreur:', error);
        showError('Une erreur est survenue. V√©rifie ta connexion et r√©essaie.');
      } finally {
        // R√©activer le bouton
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Envoyer mon son';
      }
    });

    /* ============================================
       UTILITAIRES
       ============================================ */

    // Afficher le message de succ√®s
    function showSuccess() {
      successMessage.style.display = 'block';
      errorMessage.style.display = 'none';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Afficher le message d'erreur
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      successMessage.style.display = 'none';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Sauvegarder le nom de l'utilisateur
    const savedUserName = localStorage.getItem('refbox_username');
    if (savedUserName) {
      document.getElementById('userName').value = savedUserName;
    }

    document.getElementById('userName').addEventListener('blur', (e) => {
      if (e.target.value.trim()) {
        localStorage.setItem('refbox_username', e.target.value.trim());
      }
    });
  </script>
</body>
</html>
